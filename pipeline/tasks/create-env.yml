platform: linux
inputs:
- name: deployments
outputs:
- name: deployments
run:
  path: bash
  args:
  - -c
  - |

    set -eux

    deployment_path="$PWD"/deployments/"$DEPLOYMENT_NAME"

    if [ ! -d "$deployment_path" ]; then
      echo "Please provide a valid DEPLOYMENT_NAME, the '$DEPLOYMENT_NAME' is not supported"
      exit 1
    fi

    git config --global user.name "pipeline-bot"
    git config --global user.email "pipeline-bot@example.com"

    cd "$deployment_path"
    cat > env.yml <<EOL
    # this file is generated by CI
    target: $(om interpolate -c terraform-vars.yml --path /ops_manager_dns)
    username: $OM_USERNAME
    password: $OM_PASSWORD
    decryption-passphrase: $OM_PASSWORD
    skip-ssl-validation: true
    EOL

    git add env.yml
    git commit -m "added env.yml for $DEPLOYMENT_NAME" || true
